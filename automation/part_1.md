# Automation Part 1: The first steps

In part 1 we're going to get our toes wet.  
We're going to write a PowerShell script that creates a VM, adds it to a subnet and
assigns it an IP.  

Basically we'll automate the creation of VMs.  
In the future we'll automate the installation of the Operating Systems as well.  

Now before we get started, I'll add another subnet, all the general purpose VMs will belong tot his subnet.  
(Basically any VM that is not used to manage our private cloud.)  

To do this, I added another network port to the firewall and connected it to our backbone switch.  
I'll probably come back and change this in teh future, but for now this is fine.  
Anyway, for this subnet I'll be using `172.16.2.0/24`.  

## Setting up A DHCP Server

First, we'll set up the DHCP server, with 3 scopes and then exclude our existing machines:  

```Powershell
Install-WindowsFeature DHCP -IncludeManagementTools
netsh dhcp add securitygroups
Add-DhcpServerInDC -DnsName "WinServer-1.yourdomain.local" -IPAddress 172.16.1.1
Set-DhcpServerv4FilterList -Allow $True

Add-DhcpServerv4Scope -name "BackBone Network" -StartRange 172.16.0.1 -EndRange 172.16.0.254 -SubnetMask 255.255.255.0 -State Active
Set-DhcpServerv4OptionValue -ScopeId 172.16.0.0 -DnsDomain "yourdomain.local" -DnsServer 172.16.1.1 -Router 172.16.0.254
Add-DhcpServerv4ExclusionRange -ScopeID 172.16.0.0 -StartRange 172.16.0.1 -EndRange 172.16.0.1
Add-DhcpServerv4ExclusionRange -ScopeID 172.16.0.0 -StartRange 172.16.0.254 -EndRange 172.16.0.254

Add-DhcpServerv4Scope -name "Admin LAN" -StartRange 172.16.1.1 -EndRange 172.16.1.254 -SubnetMask 255.255.255.0 -State Active
Set-DhcpServerv4OptionValue -ScopeId 172.16.1.0 -DnsDomain "yourdomain.local" -DnsServer 172.16.1.1 -Router 172.16.1.254
Add-DhcpServerv4ExclusionRange -ScopeID 172.16.1.0 -StartRange 172.16.1.1 -EndRange 172.16.1.2
Add-DhcpServerv4ExclusionRange -ScopeID 172.16.1.0 -StartRange 172.16.1.254 -EndRange 172.16.1.254

Add-DhcpServerv4Scope -name "General Purpose Network" -StartRange 172.16.2.1 -EndRange 172.16.2.254 -SubnetMask 255.255.255.0 -State Active
Set-DhcpServerv4OptionValue -ScopeId 172.16.2.0 -DnsDomain "yourdomain.local" -DnsServer 172.16.1.1 -Router 172.16.2.254
```

We've also changed set the DHCP server to only giving addresses to clients that are registered beforehand.  

Next we'll set up a `DHCP Relay` on our pfSense node.  
Under `Services` > `DHCP Relay`:

![pfSense DHCP Relay](/images/dhcp_relay.jpg "pfSense DHCP Relay configuration")

And that's it for the DHCP setup.  

## A VM-deploy script

Next we'll write a script that'll handle the deployment of our VMs.  
We'll write create a powershell module that will contain all our different functions.  

The first function will be to automate the deployment of a virtual machine.  
First we'll define its name and parameters:  

```Powershell
function New-AutoDeployVM {
    [CmdletBinding()]
    Param(
        # The name of the machine. Will be the VM name and used to register in the DNS.
        [Parameter(Mandatory=$true, Position=0)]
        [string]$Name,

        # Specifies the target Hyper-V Server.
        [Parameter(Mandatory=$true, Position=1)]
        [string]$VMHost,

        # Specifies the number of CPU Cores. Defaults to 1.
        [int]$CPUCount=1,

        # Wether to use dynamic ram or not
        [switch]$DynamicRam,

        # Specifies Startup Memory.
        [int64]$StartUpRam=1024MB,

        # Specifies the Minimum amount of dynamic.
        [int64]$MinRam=512MB,

        # Specifies the Maximum amount of dynamic.
        [int64]$MaxRam=2048MB,

        [UInt64]$DiskSize=40GB,

        [string]$SwitchName="BackBone",

        [IPAddress]$SubnetAddress,

        [ValidateSet("Nothing", "Start", "StartIfRunning")]
        [string]$AutomaticStartAction = "StartIfRunning",

        [ValidateSet("Save", "ShutDown", "TurnOff")]
        [string]$AutomaticStopAction = "ShutDown",

        [int64]$AutomaticStartDelay=60,

        [string]$ISOPath="E:\ISOs\Debian\Debian-10.6.0.iso",

        # Notes that can be added to the VM.  
        [string]$Notes="AutoGenerated VM"
    )

}
```

This basic set of parameters will serve us for now.  
Go over all of them and correct for your system where needed.  
We'll add more parameters as as they come up.  

Now bear with me, as the next part is a bit longer.  
In the function body:

```Powershell
    # Set up the required directories
    $VMDir = "D:\AutoDeployVMS\$Name"
    Invoke-Command -ComputerName $VMHost -ScriptBlock {
        param($Path)
        New-Item -Path $Path -ItemType Directory
        New-Item -Path "$Path\VM" -ItemType Directory
    } -Args $VMDir

    # Creating the VM with all the required bells and whistles
    New-VM -Name $Name -ComputerName $VMHost `
    -NoVHD -Path "$VMDir\VM" `
    -MemoryStartupBytes $StartUpRam -SwitchName $SwitchName `
    -Generation 2 -BootDevice "CD"

    Set-VM -Name $Name -ComputerName $VMHost -ProcessorCount $CPUCount `
    -AutomaticStartAction $AutomaticStartAction -AutomaticStopAction $AutomaticStopAction `
    -AutomaticStartDelay $AutomaticStartDelay -Notes $Notes

    if ($DynamicRam) {
        Set-VM -Name $Name -ComputerName $VMHost -DynamicMemory -MemoryMinimumBytes $MinRam -MemoryMaximumBytes $MaxRam
    }
    Set-VMFirmware -VMName $Name -ComputerName $VMHost -EnableSecureBoot On -SecureBootTemplate "MicrosoftUEFICertificateAuthority"
    Set-VMDvdDrive -VMName $Name -ComputerName $VMHost -Path $ISOPath

    # Create the virtual hard disk
    $VHDPath = "$VMDir\$Name.vhdx"
    New-VHD -ComputerName $VMHost -Path $VHDPath -Dynamic -SizeBytes 40GB
    Add-VMHardDiskDrive -ComputerName $VMHost -VMName $Name -Path $VHDPath
```

This will create the VM and fully configure it.  

First, we create the required Directories on the target machine.  
Because `New-item` does not have a `-ComputerName` parameter, we'll instead send it over using `Invoke-Command`.  
`Invoke-Command` remotely executes one or more commands.  
In our case even a full script.  

Next we create the Virtual Hard Disk.  
Followed by the VM itself.  
Then, because `New-VM` doesn't have all the properties we need to set, there's too many parameters I assume,
we use `Set-VM` to set the several more parameters.  
And if dynamic memory is enabled, we set that too using `Set-VM`.  

Then seeing as how Debian is supported OS for `Secure boot`, I enable that and set the Template to the correct one.  
This is similar to the `Secure boot` in your own computers BIOS/UEFI.  

Finally, we mount the default iso we'd like to install.  

That leaves the matter of assigning an IP and registering our machine in DNS.  
Add parameters for the DHCP and DNS Servers if you spread out your roles over multiple Servers.  

Now we'll have to jump through a couple more hoops:  

```Powershell
    # Hyper-V generates a semi-random MacAddress at first boot
    Start-VM -ComputerName $VMHost -Name $Name
    Stop-VM -ComputerName $VMHost -Name $Name -TurnOff
    $MacAddress = (Get-VMNetworkAdapter -VMName $Name -ComputerName $VMHost).MacAddress
    Get-VMNetworkAdapter -VMName $Name -ComputerName $VMHost | Set-VMNetworkAdapter -StaticMacAddress $MacAddress

    # Register the IP in DHCP
    $IPAddress = Get-DhcpServerv4FreeIPAddress -ScopeId $SubnetAddress
    Add-DhcpServerv4Reservation -IPAddress $IPAddress -ScopeId $SubnetAddress -ClientId $MacAddress `
        -Name $Name -Description "Auto generated lease for VM autodeploy"
    Add-DhcpServerv4Filter -List Allow -MacAddress $MacAddress -Description $Name

    # Register in DNS
    Add-DnsServerResourceRecordA -Name $Name -CreatePtr -AllowUpdateAny -IPv4Address $IPAddress -AgeRecord -ZoneName yourdomain.local
```

Usually I would make this function Omnipotent, but this is just a basis for the orchestration I'm planning to do later.  
So instead I just made this so it is "Good enough" for now.  
The full script is available at the end and [on Github](https://github.com/kazaamjt/Scripts/blob/master/VMAutoDeploy.psm1).  
As a bonus I added a Function that will clean up the VM completely.  
If you do end up using my version on github, be sure to change the domain name.  

We'll finish up this part by installing the `Hyper-V Powershell RSAT module` on WinServer-1 so that we can use it to run this script.  

```Powsershell
Install-WindowsFeature Hyper-V-PowerShell
```

[< Basics Part 3: The Great Migration](/basics/part_2.md) | [Automation Part 2: Automating Debian installations >](/Automation/part_2.md)

```Powershell
function New-AutoDeployVM {
    [CmdletBinding()]
    Param(
        # The name of the machine. Will be the VM name and used to register in the DNS.
        [Parameter(Mandatory=$true, Position=0)]
        [string]$Name,

        # Specifies the target Hyper-V Server.
        [Parameter(Mandatory=$true, Position=1)]
        [string]$VMHost,

        # Specifies the number of CPU Cores. Defaults to 1.
        [int]$CPUCount=1,

        # Wether to use dynamic ram or not
        [switch]$DynamicRam,

        # Specifies Startup Memory.
        [int64]$StartUpRam=1024MB,

        # Specifies the Minimum amount of dynamic.
        [int64]$MinRam=512MB,

        # Specifies the Maximum amount of dynamic.
        [int64]$MaxRam=2048MB,

        [UInt64]$DiskSize=40GB,

        [string]$SwitchName="BackBone",

        [IPAddress]$SubnetAddress,

        [ValidateSet("Nothing", "Start", "StartIfRunning")]
        [string]$AutomaticStartAction = "StartIfRunning",

        [ValidateSet("Save", "ShutDown", "TurnOff")]
        [string]$AutomaticStopAction = "ShutDown",

        [int64]$AutomaticStartDelay=60,

        [string]$ISOPath="E:\ISOs\Debian\Debian-10.6.0.iso",

        # Notes that can be added to the VM.  
        [string]$Notes="AutoGenerated VM"
    )

    # Set up the required directories
    $VMDir = "D:\AutoDeployVMS\$Name"
    Invoke-Command -ComputerName $VMHost -ScriptBlock {
        param($Path)
        New-Item -Path $Path -ItemType Directory
        New-Item -Path "$Path\VM" -ItemType Directory
    } -Args $VMDir

    # Creating the VM with all the required bells and whistles
    New-VM -Name $Name -ComputerName $VMHost `
    -NoVHD -Path "$VMDir\VM" `
    -MemoryStartupBytes $StartUpRam -SwitchName $SwitchName `
    -Generation 2 -BootDevice "CD"

    Set-VM -Name $Name -ComputerName $VMHost -ProcessorCount $CPUCount `
    -AutomaticStartAction $AutomaticStartAction -AutomaticStopAction $AutomaticStopAction `
    -AutomaticStartDelay $AutomaticStartDelay -Notes $Notes

    if ($DynamicRam) {
        Set-VM -Name $Name -ComputerName $VMHost -DynamicMemory -MemoryMinimumBytes $MinRam -MemoryMaximumBytes $MaxRam
    }
    Set-VMFirmware -VMName $Name -ComputerName $VMHost -EnableSecureBoot On -SecureBootTemplate "MicrosoftUEFICertificateAuthority"
    Set-VMDvdDrive -VMName $Name -ComputerName $VMHost -Path $ISOPath

    # Create the virtual hard disk
    $VHDPath = "$VMDir\$Name.vhdx"
    New-VHD -ComputerName $VMHost -Path $VHDPath -Dynamic -SizeBytes 40GB
    Add-VMHardDiskDrive -ComputerName $VMHost -VMName $Name -Path $VHDPath

    # Hyper-V generates a semi-random MacAddress at first boot
    Start-VM -ComputerName $VMHost -Name $Name
    Stop-VM -ComputerName $VMHost -Name $Name -TurnOff
    $MacAddress = (Get-VMNetworkAdapter -VMName $Name -ComputerName $VMHost).MacAddress
    Get-VMNetworkAdapter -VMName $Name -ComputerName $VMHost | Set-VMNetworkAdapter -StaticMacAddress $MacAddress

    # Register the IP in DHCP
    $IPAddress = Get-DhcpServerv4FreeIPAddress -ScopeId $SubnetAddress
    Add-DhcpServerv4Reservation -IPAddress $IPAddress -ScopeId $SubnetAddress -ClientId $MacAddress `
        -Name $Name -Description "Auto generated lease for VM autodeploy"
    Add-DhcpServerv4Filter -List Allow -MacAddress $MacAddress -Description $Name

    # Register in DNS
    Add-DnsServerResourceRecordA -Name $Name -CreatePtr -AllowUpdateAny -IPv4Address $IPAddress -AgeRecord -ZoneName yourdomain.local
}

```
